server {
    listen 443 ssl http2;
    server_name <YOUR_DOMAIN>;

    # Security headers
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # -------------------------
    # Internal file serving (X-Accel-Redirect)
    # -------------------------
    location /internal/files/ {
        internal;
        alias /var/www/cloud-storage/uploads/;
        sendfile on;
        sendfile_max_chunk 16m;
        aio on;
        directio 512;
        output_buffers 1 512k;
        tcp_nopush on;
        tcp_nodelay on;
        postpone_output 1460;
        add_header Accept-Ranges bytes always;
        add_header Cache-Control "public, max-age=3600, stale-while-revalidate=86400";
        access_log off;
    }

    # -------------------------
    # Upload endpoints — no rate limiting
    # -------------------------
    location ~ ^/api/files/(upload|chunk|finalize)$ {
        client_body_buffer_size 64M;
        client_body_timeout 600s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # -------------------------
    # Downloads / streaming
    # -------------------------
    location ~ ^/api/files/.+/(download|preview|stream)$ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Range support
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        proxy_force_ranges on;

        # Performance
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_connect_timeout 10s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        proxy_max_temp_file_size 0;

        aio on;
        directio 512;
        output_buffers 1 512k;

        proxy_intercept_errors on;
        access_log off;
    }

    # -------------------------
    # Static Assets (Next.js) - Long-term caching
    # -------------------------
    location /_next/static/ {
        proxy_pass http://127.0.0.1:3000;
        expires 365d;
        access_log off;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # -------------------------
    # Main app routes — rate limited
    # -------------------------
    location / {
        # Disable caching for HTML pages
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        proxy_hide_header Cache-Control;
        proxy_hide_header Expires;

        limit_req zone=general burst=100 nodelay;
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }
    # Sensitive files
    location ~ /\. { deny all; access_log off; log_not_found off; }
    location ~* \.(env|git|svn|htaccess|htpasswd)$ { deny all; access_log off; log_not_found off; }

    # Health check
    location = /health {
        access_log off;
        proxy_pass http://127.0.0.1:3000;
    }
}
